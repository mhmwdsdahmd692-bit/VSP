name: Linbet VPS Ultimate AI Hybrid
on:
  workflow_dispatch:

jobs:
  build-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 7200   # ğŸ” Ù…Ø¯Ø© ØªØ´ØºÙŠÙ„ 5 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©

    steps:
      # ğŸ§± 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
      - name: ğŸ§© System Setup & Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y curl wget unzip net-tools htop openssh-server fail2ban ufw
          sudo ufw allow ssh
          sudo ufw enable
          echo "âœ… System packages installed and firewall configured."

      # ğŸ” 2. Ø¥Ø¹Ø¯Ø§Ø¯ SSH Ø§Ù„Ø¢Ù…Ù†
      - name: ğŸ” Configure Secure SSH
        run: |
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo systemctl enable ssh
          sudo systemctl restart ssh
          echo "âœ… SSH Access Ready: user=root | pass=admin@123"

      # ğŸŒ 3. ØªØ«Ø¨ÙŠØª Tailscale (VPN Ù…ØµØ±ÙŠ)
      - name: ğŸŒ Install & Connect Tailscale VPN (Egypt Region)
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=linbet-vps-${{ github.run_id }}
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "âœ… Tailscale Connected (Egypt Region): $tsIP"

      # âš™ï¸ 4. ØªØ«Ø¨ÙŠØª Node.js Ùˆ PM2 ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø©
      - name: âš™ï¸ Setup Node.js & PM2
        run: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs
          sudo npm install -g pm2
          mkdir -p ~/linbet-vps
          cd ~/linbet-vps
          echo "âœ… Node.js and PM2 installed."

      # ğŸ§  5. Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Linbet VPS Ø§Ù„Ø°ÙƒÙŠ
      - name: ğŸ§  Create Linbet VPS AI Script
        run: |
          cat << 'EOF' > ~/linbet-vps/linbet-vps.js
          import axios from "axios";
          import fs from "fs";
          import os from "os";

          // ğŸŒ Ø®Ø§Ø¯Ù… Linbet Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
          const SERVER_URL = "https://linbet-server.example.com";
          const VPS_ID = "vps-" + os.hostname();
          let cache = {};

          // ğŸ§  1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
          function aiAnalyze(signals) {
            if (!signals || signals.length === 0) return null;
            const weights = signals.map(s => s.confidence || 0.5);
            const avg = weights.reduce((a, b) => a + b, 0) / weights.length;
            const best = signals.find(s => s.confidence === Math.max(...weights));
            return { best, accuracy: Math.round(avg * 100) };
          }

          // ğŸ§© 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ù…Ù† Linbet ÙˆØ§Ù„Ø®Ø§Ø¯Ù… ÙˆØ§Ù„Ù€ VPS Ù†ÙØ³Ù‡ (Hybrid)
          async function getHybridSignals() {
            try {
              const [linbet, backend, cacheSignal] = await Promise.all([
                axios.get(`${SERVER_URL}/linbet/signals`).catch(() => ({ data: [] })),
                axios.get(`${SERVER_URL}/backend/signals`).catch(() => ({ data: [] })),
                Promise.resolve(cache.lastSignal || []),
              ]);

              const combined = [...linbet.data, ...backend.data, ...cacheSignal];
              const analysis = aiAnalyze(combined);
              cache.lastSignal = combined;
              return analysis;
            } catch (err) {
              console.error("Error fetching signals:", err.message);
              return null;
            }
          }

          // ğŸ”„ 3. Ø­Ù„Ù‚Ø© Ø¬Ù„Ø¨ ÙˆØªØ­Ù„ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±
          async function signalLoop() {
            while (true) {
              const analysis = await getHybridSignals();
              if (analysis && analysis.best) {
                console.log(`ğŸ“¡ Best Signal: ${analysis.best.type} | Accuracy: ${analysis.accuracy}%`);
                await axios.post(`${SERVER_URL}/vps/update`, {
                  vps_id: VPS_ID,
                  signal: analysis.best,
                  accuracy: analysis.accuracy,
                }).catch(() => {});
              }
              await new Promise(r => setTimeout(r, 30000)); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            }
          }

          // âš”ï¸ 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ (ÙƒØ´Ù Ø§Ù„Ø­Ø¸Ø± ÙˆØªØ¨Ø¯ÙŠÙ„ IP)
          async function checkBan() {
            try {
              const res = await axios.get("https://api.ipify.org?format=json");
              if (res.data.ip && res.data.ip.includes("blocked-region")) {
                console.log("âš ï¸ Region Blocked â€” Switching VPN...");
                await exec("sudo tailscale down && sudo tailscale up --reset");
              }
            } catch {}
          }

          // ğŸ§­ 5. Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
          async function listenForNewGame() {
            setInterval(async () => {
              const res = await axios.get(`${SERVER_URL}/vps/check-game`);
              if (res.data.newGame) {
                console.log("ğŸ® New Game detected, refreshing signals...");
                cache.lastSignal = null;
              }
            }, 10000);
          }

          // ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
          (async () => {
            console.log("ğŸ”¥ Linbet VPS Ultimate AI Hybrid Started...");
            listenForNewGame();
            signalLoop();
            setInterval(checkBan, 60000);
          })();
          EOF

          echo "âœ… Linbet VPS AI Script created."

      # ğŸ§° 6. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª ÙˆÙ…Ø±Ø§Ù‚Ø¨ØªÙ‡
      - name: ğŸ§° Start VPS Script
        run: |
          cd ~/linbet-vps
          pm2 start linbet-vps.js --name linbet-vps
          pm2 save
          pm2 startup
          echo "âœ… VPS AI Hybrid running continuously with PM2."

      # ğŸ•¹ï¸ 7. Keep VPS Alive
      - name: ğŸ•¹ï¸ Keep VPS Alive
        run: |
          while true; do
            echo "[$(date)] Linbet VPS AI Hybrid is running smoothly..."
            sleep 300
          done
